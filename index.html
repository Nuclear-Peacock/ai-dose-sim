<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2 Simulation: Low Dose Acquisition</title>
    <style>
        body { font-family: sans-serif; background: #111; color: #eee; text-align: center; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: #222; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        canvas { max-width: 100%; border: 1px solid #555; border-radius: 4px; }
        input[type=range] { width: 100%; margin: 20px 0; }
        .labels { display: flex; justify-content: space-between; color: #aaa; font-size: 0.9em; }
        .status { margin-top: 15px; font-weight: bold; color: #00ffcc; min-height: 24px; }
        .loading { color: #ffcc00; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <h2>AI Dose Reduction Simulator</h2>
    <p style="color: #aaa; font-size: 0.9em;">Phase 2: Image Acquisition & Reconstruction</p>
    
    <canvas id="displayCanvas"></canvas>
    <div id="loadingText" class="loading">Loading and generating noise layers...</div>

    <div class="controls" style="display:none;" id="controls">
        <input type="range" min="0" max="100" value="100" id="doseSlider">
        <div class="labels">
            <span>Low Dose (Noisy)</span>
            <span>Standard Dose (AI Clean)</span>
        </div>
        <div class="status" id="statusText">AI Reconstruction: 100%</div>
    </div>
</div>

<script>
    const imagePath = 'ct-slice.jpg'; // MAKE SURE THIS MATCHES YOUR FILENAME
    const canvas = document.getElementById('displayCanvas');
    const ctx = canvas.getContext('2d');
    const slider = document.getElementById('doseSlider');
    const statusText = document.getElementById('statusText');
    const controls = document.getElementById('controls');
    const loadingText = document.getElementById('loadingText');

    let originalData = null; // Store the clean pixel data

    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.src = imagePath;

    img.onload = function() {
        // 1. Setup Canvas
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        // 2. Save Original (Clean) Pixel Data
        originalData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // 3. Ready to go
        loadingText.style.display = 'none';
        controls.style.display = 'block';
        addNoise(0); // Initialize with 0 noise (clean)
    };

    img.onerror = function() {
        loadingText.innerText = "Error: Could not load image. Check filename in GitHub.";
        loadingText.style.color = "red";
    };

    // SLIDER EVENT LISTENER
    slider.oninput = function() {
        // Invert value: Slider 100 = 0 Noise. Slider 0 = Max Noise.
        const intensity = 100 - this.value;
        addNoise(intensity);

        // Update Text
        if (this.value == 100) statusText.innerText = "AI Reconstruction: 100% (Original Fidelity)";
        else if (this.value < 30) statusText.innerText = "Simulating: Ultra-Low Dose (Raw)";
        else statusText.innerText = `Simulating: ${this.value}% Dose`;
    };

    // NOISE GENERATOR FUNCTION
    function addNoise(intensity) {
        if (!originalData) return;

        // Create a copy of the original pixels
        const processed = ctx.createImageData(canvas.width, canvas.height);
        const data = processed.data;
        const source = originalData.data;
        
        // Noise factor (0 to 100)
        const factor = intensity * 1.5; 

        for (let i = 0; i < data.length; i += 4) {
            // Generate simple random noise
            // (Math.random() - 0.5) gives range [-0.5, 0.5]
            const noise = (Math.random() - 0.5) * factor;

            // Apply noise to RGB channels
            data[i] = source[i] + noise;     // Red
            data[i+1] = source[i+1] + noise; // Green
            data[i+2] = source[i+2] + noise; // Blue
            data[i+3] = 255;                 // Alpha (Solid)
        }

        ctx.putImageData(processed, 0, 0);
    }
</script>

</body>
</html>
